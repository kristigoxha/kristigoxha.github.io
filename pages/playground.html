<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pookie's Playground</title>
    <link rel="icon" href="/assets/icons/favicon.ico">
    
    <!-- Import your existing CSS files -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/responsive.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Additional styles for the playground -->
    <style>
        .playground-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            text-align: center;
        }
        
        .playground-header {
            margin-bottom: 2rem;
        }
        
        .playground-header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .playground-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .game-card h3 {
            margin: 0 0 1rem 0;
            font-size: 1.5rem;
        }
        
        .game-card p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .coming-soon {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
        }
        
        .back-button {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Word of the Day Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            color: white;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .close {
            color: white;
            float: right;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        /* Streak Counter Styles */
        .streak-container {
            background: rgba(255, 215, 0, 0.15);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .streak-item {
            text-align: center;
        }
        
        .streak-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .streak-number {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .streak-emoji {
            font-size: 1.5rem;
            margin-left: 5px;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin: 1.5rem 0;
            justify-content: center;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Word History Styles */
        .history-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 10px;
            text-align: left;
            border-left: 3px solid rgba(255, 215, 0, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
        }
        
        .history-date {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }
        
        .history-word {
            font-size: 1.2rem;
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .history-definition {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }
        
        .history-badge {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            margin-left: 10px;
        }
        
        .history-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }
        
        .language-selector {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
        }
        
        .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .lang-btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        .word-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            text-align: left;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .word-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #FFD700;
            text-align: center;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
            position: relative;
            padding-bottom: 1rem;
        }
        
        .word-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            border-radius: 2px;
        }
        
        .word-pronunciation {
            text-align: center;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            font-style: italic;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }
        
        .word-type {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .word-definition {
            font-size: 1.15rem;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.95);
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #FFD700;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .word-example {
            font-size: 1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-top: 1rem;
            position: relative;
            padding-left: 3rem;
        }
        
        .word-example::before {
            content: 'üí¨';
            position: absolute;
            left: 1rem;
            top: 1rem;
            font-size: 1.5rem;
        }
        
        /* Sentence Section Styles */
        .sentence-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .sentence-header {
            font-size: 1.3rem;
            color: #FFD700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sentence-prompt {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .sentence-input-group {
            margin-bottom: 1rem;
        }
        
        .sentence-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .sentence-textarea:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.15);
        }
        
        .sentence-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .sentence-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .sentence-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .sentence-btn-save {
            background: #FFD700;
            color: #764ba2;
        }
        
        .sentence-btn-save:hover {
            background: #FFC700;
            transform: translateY(-2px);
        }
        
        .sentence-btn-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .sentence-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sentence-btn-edit {
            background: rgba(255, 215, 0, 0.3);
            color: white;
            padding: 6px 15px;
            font-size: 0.85rem;
        }
        
        .sentence-btn-edit:hover {
            background: rgba(255, 215, 0, 0.4);
        }
        
        .sentences-display {
            margin-top: 1rem;
        }
        
        .sentence-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid rgba(255, 215, 0, 0.5);
        }
        
        .sentence-author {
            font-size: 0.85rem;
            color: #FFD700;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .sentence-text {
            font-size: 1rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .sentence-empty {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }
        
        .sentence-status {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .sentence-status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #90EE90;
        }
        
        .sentence-status.error {
            background: rgba(220, 53, 69, 0.2);
            color: #FF6B6B;
        }
        
        .word-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .word-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .word-source {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .loading {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .playground-container {
                padding: 1rem;
                margin-top: 4rem;
            }
            
            .back-button {
                top: 1rem;
                left: 1rem;
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
                z-index: 20;
            }
            
            .playground-header h1 {
                font-size: 2rem;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 1.5rem;
            }
            
            .language-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .lang-btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .word-content {
                padding: 1.5rem;
            }
            
            .word-title {
                font-size: 1.8rem;
            }
            
            .word-definition {
                font-size: 1rem;
                padding: 1rem;
            }
            
            .word-example {
                font-size: 0.95rem;
                padding: 0.8rem 1rem;
                padding-left: 2.5rem;
            }
            
            .word-example::before {
                left: 0.8rem;
                font-size: 1.2rem;
            }
            
            .word-meta {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
                font-size: 0.8rem;
            }
            
            .sentence-section {
                padding: 1rem;
            }
            
            .sentence-buttons {
                flex-direction: column;
            }
            
            .sentence-btn {
                width: 100%;
            }
            
            .streak-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">‚Üê Back to Home</a>
    
    <div class="playground-container">
        <div class="playground-header">
            <h1>üéÆ Pookie's Playground</h1>
            <p>Fun games and learning activities for us to enjoy together!</p>
        </div>
        
        <div class="game-grid">
            <button class="game-card" onclick="openWordOfTheDay()">
                <h3>üìö Word of the Day</h3>
                <p>Learn a new word every day in Albanian or English</p>
            </button>
        </div>
        
        <div class="coming-soon">
            <h3>üöß Working on adding more stuff, stay tuned baby...</h3>
            <p>More exciting games and activities coming soon!</p>
        </div>
    </div>
    
    <!-- Word of the Day Modal -->
    <div id="wordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeWordOfTheDay()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 1rem;">üìö Word of the Day</h2>
            
            <!-- Streak Counter -->
            <div id="streakContainer" class="streak-container" style="display: none;">
                <div class="streak-item">
                    <div class="streak-label">Current Streak</div>
                    <div class="streak-number">
                        <span id="currentStreak">0</span>
                        <span class="streak-emoji">üî•</span>
                    </div>
                </div>
                <div class="streak-item">
                    <div class="streak-label">Longest Streak</div>
                    <div class="streak-number">
                        <span id="longestStreak">0</span>
                        <span class="streak-emoji">üèÜ</span>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" id="todayTab" onclick="switchTab('today')">
                    Today's Word
                </button>
                <button class="tab-btn" id="historyTab" onclick="switchTab('history')">
                    Word History
                </button>
            </div>
            
            <!-- Today's Word Tab -->
            <div id="todayContent" class="tab-content active">
                <div class="language-selector">
                    <button class="lang-btn" id="albanianBtn" onclick="selectLanguage('albanian')">
                        üá¶üá± Albanian
                    </button>
                    <button class="lang-btn" id="englishBtn" onclick="selectLanguage('english')">
                        üá∫üá∏ English
                    </button>
                </div>
                
                <div id="wordContent" class="word-content" style="display: none;">
                    <div id="wordDisplay"></div>
                    
                    <!-- Sentence Section -->
                    <div class="sentence-section" id="sentenceSection" style="display: none;">
                        <div class="sentence-header">
                            ‚úçÔ∏è Use it in a Sentence
                        </div>
                        
                        <div id="sentenceForm" style="display: none;">
                            <div class="sentence-prompt">
                                Try using this word in your own sentence:
                            </div>
                            <div class="sentence-input-group">
                                <textarea 
                                    id="sentenceInput" 
                                    class="sentence-textarea" 
                                    placeholder="Type your sentence here..."
                                    maxlength="500"
                                ></textarea>
                            </div>
                            <div class="sentence-buttons">
                                <button class="sentence-btn sentence-btn-cancel" onclick="cancelSentence()">
                                    Cancel
                                </button>
                                <button class="sentence-btn sentence-btn-save" onclick="saveSentence()">
                                    üíæ Save Sentence
                                </button>
                            </div>
                        </div>
                        
                        <div id="sentencesDisplay" class="sentences-display">
                            <!-- Sentences will be displayed here -->
                        </div>
                        
                        <div id="sentenceStatus" class="sentence-status" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- History Tab -->
            <div id="historyContent" class="tab-content">
                <div class="history-container" id="historyContainer">
                    <div class="loading">Loading history...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://bcjmlhxuakqqqdjrtntj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjam1saHh1YWtxcXFkanJ0bnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTMxMzYsImV4cCI6MjA2NjE2OTEzNn0.3vV15QSv4y3mNRJfARPHlk-GvJGO65r594ss5kSGK3Y';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State
        let currentLanguage = null;
        let currentWord = null;
        let currentUser = null;
        let currentUsername = null;
        let autoreceiverEmail = null;
        let autoreceiverUsername = null;
        let isEditingMode = false;
        let editingSentenceId = null;
        let currentTab = 'today';
        
        // Check authentication and load user data
        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadStreak();
            }
            return user;
        }
        
        // Load user profile and autoreceiver
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const { data: profile } = await supabase
                .from('profiles')
                .select('username, autoreceiver_email')
                .eq('id', currentUser.id)
                .single();
            
            if (profile) {
                currentUsername = profile.username || currentUser.email.split('@')[0];
                autoreceiverEmail = profile.autoreceiver_email;
                
                // Get autoreceiver's username if they exist
                if (autoreceiverEmail) {
                    const { data: autoProfile } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('email', autoreceiverEmail)
                        .single();
                    
                    if (autoProfile) {
                        autoreceiverUsername = autoProfile.username || autoreceiverEmail.split('@')[0];
                    }
                }
            }
        }
        
        // Load and display streak
        async function loadStreak() {
            if (!currentUser) return;
            
            try {
                const { data: streak } = await supabase
                    .from('word_streaks')
                    .select('current_streak, longest_streak')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (streak) {
                    document.getElementById('currentStreak').textContent = streak.current_streak || 0;
                    document.getElementById('longestStreak').textContent = streak.longest_streak || 0;
                    document.getElementById('streakContainer').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading streak:', error);
            }
        }
        
        // Update streak when saving a sentence
        async function updateStreak() {
            if (!currentUser) return;
            
            try {
                // Call the database function to update streak
                const { data, error } = await supabase
                    .rpc('update_word_streak', { p_user_id: currentUser.id });
                
                if (!error && data && data[0]) {
                    const result = data[0];
                    document.getElementById('currentStreak').textContent = result.current_streak;
                    document.getElementById('longestStreak').textContent = result.longest_streak;
                    
                    if (result.streak_updated) {
                        // Animate streak update
                        const streakContainer = document.getElementById('streakContainer');
                        streakContainer.style.animation = 'none';
                        setTimeout(() => {
                            streakContainer.style.animation = 'slideDown 0.5s ease-out';
                        }, 10);
                    }
                }
            } catch (error) {
                console.error('Error updating streak:', error);
            }
        }
        
        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Content').classList.add('active');
            
            // Load history if switching to history tab
            if (tab === 'history' && currentUser) {
                loadWordHistory();
            }
        }
        
        // Load word history
        async function loadWordHistory() {
            if (!currentUser) return;
            
            const historyContainer = document.getElementById('historyContainer');
            historyContainer.innerHTML = '<div class="loading">Loading history...</div>';
            
            try {
                const { data: history } = await supabase
                    .from('word_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('word_date', { ascending: false })
                    .limit(30);
                
                if (!history || history.length === 0) {
                    historyContainer.innerHTML = '<div class="history-empty">No word history yet. Start learning words to build your history!</div>';
                    return;
                }
                
                let historyHTML = '';
                history.forEach(item => {
                    const date = new Date(item.word_date).toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    historyHTML += `
                        <div class="history-item" onclick="viewHistoryWord('${escapeHtml(item.word)}', '${item.word_language}', '${escapeHtml(item.definition || '')}')">
                            <div class="history-date">${date}</div>
                            <div class="history-word">
                                ${escapeHtml(item.word)}
                                <span class="history-badge">${item.word_language === 'albanian' ? 'üá¶üá±' : 'üá∫üá∏'}</span>
                                ${item.has_sentence ? '<span class="history-badge">‚úçÔ∏è</span>' : ''}
                            </div>
                            ${item.definition ? `<div class="history-definition">${escapeHtml(item.definition.substring(0, 100))}${item.definition.length > 100 ? '...' : ''}</div>` : ''}
                        </div>
                    `;
                });
                
                historyContainer.innerHTML = historyHTML;
                
            } catch (error) {
                console.error('Error loading history:', error);
                historyContainer.innerHTML = '<div class="error">Error loading history</div>';
            }
        }
        
        // View a word from history
        function viewHistoryWord(word, language, definition) {
            // Switch to today tab
            switchTab('today');
            
            // Set the language and load the word
            currentLanguage = language;
            currentWord = word;
            
            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(language + 'Btn').classList.add('active');
            
            // Display the word
            const displayDiv = document.getElementById('wordDisplay');
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            displayDiv.innerHTML = `
                <div class="word-title">${word}</div>
                <div class="word-definition">
                    ${definition || 'Definition not available'}
                </div>
                <div class="word-meta">
                    <div class="word-date">üìÖ From History</div>
                    <div class="word-source">${language === 'albanian' ? 'üá¶üá± Albanian' : 'üá∫üá∏ English'}</div>
                </div>
            `;
            
            document.getElementById('wordContent').style.display = 'block';
            
            // Note: Don't show sentence section for historical words
            document.getElementById('sentenceSection').style.display = 'none';
        }
        
        // Save word to history
        async function saveToHistory(word, language, definition) {
            if (!currentUser || !word) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if already exists
                const { data: existing } = await supabase
                    .from('word_history')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('word', word.toLowerCase())
                    .eq('word_language', language)
                    .eq('word_date', today)
                    .single();
                
                if (!existing) {
                    // Insert new history entry
                    await supabase
                        .from('word_history')
                        .insert({
                            user_id: currentUser.id,
                            word: word.toLowerCase(),
                            word_language: language,
                            definition: definition,
                            word_date: today,
                            has_sentence: false
                        });
                }
            } catch (error) {
                console.error('Error saving to history:', error);
            }
        }
        
        // Update history when sentence is saved
        async function updateHistoryHasSentence(word, language) {
            if (!currentUser || !word) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                await supabase
                    .from('word_history')
                    .update({ has_sentence: true })
                    .eq('user_id', currentUser.id)
                    .eq('word', word.toLowerCase())
                    .eq('word_language', language)
                    .eq('word_date', today);
            } catch (error) {
                console.error('Error updating history:', error);
            }
        }
        
        function openWordOfTheDay() {
            document.getElementById('wordModal').style.display = 'block';
            // Reset state
            currentLanguage = null;
            currentWord = null;
            document.getElementById('wordContent').style.display = 'none';
            document.getElementById('sentenceSection').style.display = 'none';
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            
            // Check authentication when opening modal
            checkAuth();
            
            // Start on today tab
            switchTab('today');
        }
        
        function closeWordOfTheDay() {
            document.getElementById('wordModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('wordModal');
            if (event.target === modal) {
                closeWordOfTheDay();
            }
        }
        
        async function selectLanguage(language) {
            currentLanguage = language;
            
            // Update button states
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(language + 'Btn').classList.add('active');
            
            // Show content area with loading
            const contentDiv = document.getElementById('wordContent');
            const displayDiv = document.getElementById('wordDisplay');
            
            contentDiv.style.display = 'block';
            displayDiv.innerHTML = '<div class="loading">Loading word of the day...</div>';
            
            try {
                if (language === 'albanian') {
                    await loadAlbanianWord();
                } else {
                    await loadEnglishWord();
                }
                
                // Show sentence section after word loads
                if (currentUser && currentWord) {
                    document.getElementById('sentenceSection').style.display = 'block';
                    await loadSentences();
                }
            } catch (error) {
                console.error('Error loading word:', error);
                displayDiv.innerHTML = '<div class="error">Sorry, could not load the word of the day. Please try again later.</div>';
            }
        }
        
        async function loadAlbanianWord() {
            try {
                const response = await fetch('https://marxfnwnc2.execute-api.eu-central-1.amazonaws.com/prod/wordoftheday');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch Albanian word');
                }
                
                const data = await response.json();
                currentWord = data.word;
                
                const displayDiv = document.getElementById('wordDisplay');
                const today = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const definition = data.definition;
                
                displayDiv.innerHTML = `
                    <div class="word-title">${data.word}</div>
                    ${data.pronunciation ? `<div class="word-pronunciation">[${data.pronunciation}]</div>` : ''}
                    ${data.type ? `<span class="word-type">${data.type}</span>` : ''}
                    <div class="word-definition">
                        <strong>Definition:</strong> ${definition}
                    </div>
                    ${data.example ? `
                        <div class="word-example">
                            ${data.example}
                        </div>
                    ` : ''}
                    <div class="word-meta">
                        <div class="word-date">üìÖ ${today}</div>
                        <div class="word-source">üá¶üá± Albanian</div>
                    </div>
                `;
                
                // Save to history
                await saveToHistory(data.word, 'albanian', definition);
            } catch (error) {
                throw error;
            }
        }
        
        async function loadEnglishWord() {
            try {
                // Using a CORS proxy to fetch the RSS feed
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://www.merriam-webster.com/wotd/feed/rss2');
                
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch English word');
                }
                
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Get the first item (today's word)
                const firstItem = xmlDoc.querySelector('item');
                if (!firstItem) {
                    throw new Error('No word found in RSS feed');
                }
                
                const title = firstItem.querySelector('title').textContent.trim();
                currentWord = title;
                
                const description = firstItem.querySelector('description').textContent;
                
                // Parse the HTML content in description to extract the clean definition
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = description;
                
                // Extract different parts of the definition
                let definition = '';
                let example = '';
                let wordType = '';
                
                const paragraphs = tempDiv.querySelectorAll('p');
                
                for (let p of paragraphs) {
                    const text = p.textContent.trim();
                    
                    // Skip empty paragraphs and metadata
                    if (!text || text.includes('Merriam-Webster')) continue;
                    
                    // Look for word type (noun, verb, etc.)
                    if (text.match(/^(noun|verb|adjective|adverb|pronoun|preposition|conjunction|interjection)/i)) {
                        wordType = text.split(':')[0].trim();
                        definition = text.split(':')[1]?.trim() || text;
                    }
                    // Look for examples (usually contain //)
                    else if (text.includes('//')) {
                        example = text;
                    }
                    // Regular definition
                    else if (text.length > 50 && !definition) {
                        definition = text;
                    }
                }
                
                // If no definition found, use the first substantial paragraph
                if (!definition) {
                    for (let p of paragraphs) {
                        const text = p.textContent.trim();
                        if (text.length > 50 && !text.includes('Merriam-Webster')) {
                            definition = text;
                            break;
                        }
                    }
                }
                
                const today = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const displayDiv = document.getElementById('wordDisplay');
                displayDiv.innerHTML = `
                    <div class="word-title">${title}</div>
                    ${wordType ? `<span class="word-type">${wordType}</span>` : ''}
                    <div class="word-definition">
                        ${definition || 'Definition not available'}
                    </div>
                    ${example ? `
                        <div class="word-example">
                            ${example}
                        </div>
                    ` : ''}
                    <div class="word-meta">
                        <div class="word-date">üìÖ ${today}</div>
                        <div class="word-source">üá∫üá∏ Merriam-Webster</div>
                    </div>
                `;
                
                // Save to history
                await saveToHistory(title, 'english', definition);
            } catch (error) {
                throw error;
            }
        }
        
        // Sentence Management Functions
        async function loadSentences() {
            if (!currentUser || !currentWord || !currentLanguage) return;
            
            const sentencesDisplay = document.getElementById('sentencesDisplay');
            const sentenceForm = document.getElementById('sentenceForm');
            
            try {
                // Get today's sentences for this word
                const today = new Date().toISOString().split('T')[0];
                
                // Get user's sentence
                const { data: userSentence } = await supabase
                    .from('word_sentences')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('word', currentWord.toLowerCase())
                    .eq('word_language', currentLanguage)
                    .eq('word_date', today)
                    .single();
                
                // Get autoreceiver's sentence if applicable
                let autoreceiverSentence = null;
                if (autoreceiverEmail) {
                    const { data: autoUser } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('email', autoreceiverEmail)
                        .single();
                    
                    if (autoUser) {
                        const { data: autoSentence } = await supabase
                            .from('word_sentences')
                            .select('*')
                            .eq('user_id', autoUser.id)
                            .eq('word', currentWord.toLowerCase())
                            .eq('word_language', currentLanguage)
                            .eq('word_date', today)
                            .single();
                        
                        autoreceiverSentence = autoSentence;
                    }
                }
                
                // Build display HTML
                let displayHTML = '';
                
                if (userSentence) {
                    displayHTML += `
                        <div class="sentence-item">
                            <div class="sentence-author">You said:</div>
                            <div class="sentence-text">${escapeHtml(userSentence.sentence)}</div>
                            <button class="sentence-btn sentence-btn-edit" onclick="editSentence('${userSentence.id}', '${escapeHtml(userSentence.sentence)}')">
                                ‚úèÔ∏è Edit
                            </button>
                        </div>
                    `;
                    sentenceForm.style.display = 'none';
                } else {
                    displayHTML += `
                        <div class="sentence-empty">
                            You haven't used this word in a sentence yet.
                            <br>
                            <button class="sentence-btn sentence-btn-save" style="margin-top: 10px;" onclick="showSentenceForm()">
                                ‚úçÔ∏è Create Sentence
                            </button>
                        </div>
                    `;
                    sentenceForm.style.display = 'none';
                }
                
                // Display autoreceiver's sentence if found
                if (autoreceiverSentence) {
                    const displayName = autoreceiverUsername || autoreceiverEmail.split('@')[0];
                    displayHTML += `
                        <div class="sentence-item">
                            <div class="sentence-author">${escapeHtml(displayName)} said:</div>
                            <div class="sentence-text">${escapeHtml(autoreceiverSentence.sentence)}</div>
                        </div>
                    `;
                } else if (autoreceiverEmail) {
                    const displayName = autoreceiverUsername || autoreceiverEmail.split('@')[0];
                    displayHTML += `
                        <div class="sentence-item" style="opacity: 0.6;">
                            <div class="sentence-author">${escapeHtml(displayName)}:</div>
                            <div class="sentence-text">Hasn't used this word yet</div>
                        </div>
                    `;
                }
                
                sentencesDisplay.innerHTML = displayHTML;
                
            } catch (error) {
                console.error('Error loading sentences:', error);
                sentencesDisplay.innerHTML = '<div class="sentence-empty">Error loading sentences</div>';
            }
        }
        
        function showSentenceForm() {
            document.getElementById('sentenceForm').style.display = 'block';
            document.getElementById('sentencesDisplay').style.display = 'none';
            document.getElementById('sentenceInput').value = '';
            document.getElementById('sentenceInput').focus();
            isEditingMode = false;
            editingSentenceId = null;
        }
        
        function editSentence(sentenceId, currentSentence) {
            document.getElementById('sentenceForm').style.display = 'block';
            document.getElementById('sentencesDisplay').style.display = 'none';
            document.getElementById('sentenceInput').value = currentSentence;
            document.getElementById('sentenceInput').focus();
            isEditingMode = true;
            editingSentenceId = sentenceId;
        }
        
        function cancelSentence() {
            document.getElementById('sentenceForm').style.display = 'none';
            document.getElementById('sentencesDisplay').style.display = 'block';
            document.getElementById('sentenceInput').value = '';
            isEditingMode = false;
            editingSentenceId = null;
        }
        
        async function saveSentence() {
            if (!currentUser || !currentWord || !currentLanguage) {
                showStatus('Please log in to save sentences', 'error');
                return;
            }
            
            const sentenceInput = document.getElementById('sentenceInput');
            const sentence = sentenceInput.value.trim();
            
            if (!sentence) {
                showStatus('Please enter a sentence', 'error');
                return;
            }
            
            // Check if the word is used in the sentence (case-insensitive)
            const wordLower = currentWord.toLowerCase();
            const sentenceLower = sentence.toLowerCase();
            
            if (!sentenceLower.includes(wordLower)) {
                showStatus(`Please use the word "${currentWord}" in your sentence`, 'error');
                return;
            }
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                if (isEditingMode && editingSentenceId) {
                    // Update existing sentence
                    const { error } = await supabase
                        .from('word_sentences')
                        .update({
                            sentence: sentence,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', editingSentenceId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) throw error;
                    showStatus('Sentence updated successfully!', 'success');
                } else {
                    // Check if sentence already exists for today
                    const { data: existing } = await supabase
                        .from('word_sentences')
                        .select('id')
                        .eq('user_id', currentUser.id)
                        .eq('word', wordLower)
                        .eq('word_language', currentLanguage)
                        .eq('word_date', today)
                        .single();
                    
                    if (existing) {
                        // Update existing
                        const { error } = await supabase
                            .from('word_sentences')
                            .update({
                                sentence: sentence,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existing.id);
                        
                        if (error) throw error;
                    } else {
                        // Insert new
                        const { error } = await supabase
                            .from('word_sentences')
                            .insert({
                                user_id: currentUser.id,
                                word: wordLower,
                                word_language: currentLanguage,
                                sentence: sentence,
                                word_date: today
                            });
                        
                        if (error) throw error;
                        
                        // Update streak on new sentence
                        await updateStreak();
                    }
                    showStatus('Sentence saved successfully!', 'success');
                }
                
                // Update history to show sentence was created
                await updateHistoryHasSentence(wordLower, currentLanguage);
                
                // Reset form and reload sentences
                cancelSentence();
                await loadSentences();
                
            } catch (error) {
                console.error('Error saving sentence:', error);
                showStatus('Error saving sentence. Please try again.', 'error');
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('sentenceStatus');
            statusEl.textContent = message;
            statusEl.className = `sentence-status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });
    </script>
</body>
</html>
