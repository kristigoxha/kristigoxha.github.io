<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pookie's Home</title>
    <link rel="icon" href="/favicon.ico" />
    
    <!-- Security -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co https://cdn.jsdelivr.net;
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co wss://bcjmlhxuakqqqdjrtntj.supabase.co;
      "
    />
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A loving app for Pookie with boings and photo sharing" />
    <meta name="theme-color" content="#a18cd1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pookie's Home" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/pwa_manifest.json" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-128x128.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192x192.png" />

    <!-- CSS Files with fallback styles -->
    <link rel="stylesheet" href="css/base.css" onerror="console.warn('Failed to load base.css')" />
    <link rel="stylesheet" href="css/layout.css" onerror="console.warn('Failed to load layout.css')" />
    <link rel="stylesheet" href="css/components.css" onerror="console.warn('Failed to load components.css')" />
    <link rel="stylesheet" href="css/animations.css" onerror="console.warn('Failed to load animations.css')" />
    
    <!-- Inline critical styles for cookie popup -->
    <style>
      .cookie-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .cookie-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }
      
      .cookie-popup {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        margin: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: cookieSlideIn 0.4s ease-out;
      }
      
      @keyframes cookieSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      @keyframes cookieSlideOut {
        from { transform: translateY(0); opacity: 1; }
        to { transform: translateY(-50px); opacity: 0; }
      }
      
      .cookie-btn {
        padding: 12px 24px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s ease;
      }
      
      .cookie-btn:hover {
        transform: translateY(-2px);
      }
      
      .cookie-btn-accept {
        background: #4CAF50;
        color: white;
      }
      
      .cookie-btn-reject {
        background: #f44336;
        color: white;
      }
      
      .cookie-title {
        font-size: 24px;
        font-weight: bold;
        margin: 15px 0;
        color: #333;
      }
      
      .cookie-description {
        margin: 15px 0;
        color: #666;
        line-height: 1.4;
      }
      
      .character-image {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 15px;
      }
      
      /* Debug styles */
      .debug-info {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        z-index: 9999;
        display: none;
      }
    </style>

    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  
  <body>
    <!-- Debug Info Panel (hidden by default) -->
    <div id="debug-info" class="debug-info">
      <div>Cookie Consent: <span id="debug-consent">Loading...</span></div>
      <div>Popup Showing: <span id="debug-showing">false</span></div>
      <div>System Init: <span id="debug-init">false</span></div>
      <button onclick="window.debugCookies()" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">Debug</button>
      <button onclick="window.resetCookieConsent()" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">Reset</button>
      <button onclick="document.getElementById('debug-info').style.display='none'" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">Hide</button>
    </div>

    <!-- Cookie Consent Overlay -->
    <div id="cookie-overlay" class="cookie-overlay">
      <div class="cookie-popup">
        <div class="cookie-character">
          <img
            src="assets/images/Cookie.png"
            alt="Friendly guy offering cookies"
            class="character-image"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <div class="character-image" style="display: none">ğŸ§‘â€ğŸ³</div>
        </div>

        <div class="cookie-title">ğŸª Hi there Pookie!</div>

        <div class="cookie-speech">
          <div class="speech-text">
            "Would you like some fresh cookies baked with love booboo?ğŸ˜Š"
          </div>
        </div>

        <div class="cookie-description">
          We use cookies to enhance your experience, remember your preferences, and keep track of your boings! 
          Don't worry, we only use them to make the app work better for you. â¤ï¸
        </div>

        <div class="cookie-buttons">
          <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">
            ğŸª Yes boo, I'll take some!
          </button>
          <button class="cookie-btn cookie-btn-reject" onclick="rejectCookies()">
            ğŸ˜” No doodoo thanks.
          </button>
        </div>
      </div>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section">
      <input type="email" id="email" placeholder="you@example.com" />
      <input type="password" id="password" placeholder="Password" />
      <div>
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
      </div>
      <p id="login-message"></p>
      <input type="email" id="reset-email" placeholder="Forgot password? Enter your email" />
      <button onclick="resetPassword()">Send Reset Link</button>
      <p id="reset-message"></p>
    </div>

    <!-- APP SECTION -->
    <div id="app-section">
      <div class="pwa-status" id="pwa-status"></div>
      <div id="counter">Boings today: <span id="todayCount">0</span></div>
      
      <button id="menu-toggle" class="hamburger" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      
      <nav id="menu">
        <button onclick="showSettingsModal()">âš™ï¸ Settings</button>
        <button onclick="showPasswordModal()">ğŸ”’ Change Password</button>
        <button onclick="window.open('/gallery.html', '_blank')">ğŸ–¼ï¸ Full Gallery</button>
        <button id="pwa-install-menu" class="pwa-install-menu-btn" onclick="handlePWAInstall()">
          ğŸ“± Install App
        </button>
        <button onclick="logout()">ğŸ‘‹ Logout</button>
        <!-- Debug menu item (only show in development) -->
        <button onclick="document.getElementById('debug-info').style.display='block'" style="display: none;" id="debug-menu-btn">
          ğŸ› Debug Info
        </button>
      </nav>

      <div id="emoji">ğŸ</div>
      <div id="message">I LOVE YOU POOKIE</div>

      <a id="gift-box" href="/gallery.html" target="_blank">
        ğŸ Upload a surprise for Pookie
      </a>

      <button class="gallery-toggle" onclick="showPhotoPreview()">
        ğŸ“¸ Show Recent Shared Photos
      </button>

      <div class="history-link">
        <a href="/history.html" target="_blank">ğŸ“Š View Boing History</a>
      </div>

      <div id="hint">
        Hint: Increase the audio and tap the emoji for a surprise booboo
      </div>
    </div>

    <!-- PWA Update Banner -->
    <div id="pwa-update-banner" class="pwa-update-banner">
      <span>ğŸ†• App update available!</span>
      <button onclick="updatePWA()">Update</button>
      <button class="close-btn" onclick="hidePWAUpdateBanner()">Later</button>
    </div>

    <!-- Password Modal -->
    <div id="password-modal">
      <div>
        <h3>Change Password</h3>
        <input type="password" id="current-password" placeholder="Current Password" />
        <input type="password" id="new-password" placeholder="New Password" />
        <div>
          <button onclick="changePassword()">Submit</button>
          <button onclick="closePasswordModal()">Cancel</button>
        </div>
        <p id="password-change-message"></p>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal" onclick="closeSettingsModal(event)">
      <div class="settings-modal-content" onclick="event.stopPropagation()">
        <div class="settings-header">âš™ï¸ Settings</div>

        <div class="settings-section">
          <h3>ğŸ‘¤ Username</h3>
          <div id="current-username-display" class="current-username">
            Current: <span id="current-username-text">Loading...</span>
          </div>
          <input type="text" id="new-username" class="settings-input" placeholder="Enter new username" />
          <div class="settings-note">Your username will be displayed when sharing photos</div>
        </div>

        <div class="settings-section">
          <h3>ğŸ“§ Auto-receiver</h3>
          <div class="settings-note" style="margin-bottom: 15px">
            Set an email that will automatically be added to all your photo shares
          </div>
          <input type="email" id="autoreceiver-email" class="settings-input" placeholder="Enter email address" />
          <div id="current-autoreceiver" class="autoreceiver-display" style="display: none">
            <strong>Current auto-receiver:</strong>
            <div id="autoreceiver-tag-container" style="margin-top: 8px"></div>
          </div>
        </div>

        <div class="settings-buttons">
          <button class="settings-btn settings-btn-primary" onclick="saveSettings()">
            ğŸ’¾ Save Changes
          </button>
          <button class="settings-btn settings-btn-secondary" onclick="closeSettingsModal()">
            âŒ Cancel
          </button>
        </div>

        <div id="settings-message" style="margin-top: 15px; text-align: center; font-weight: 600"></div>
      </div>
    </div>

    <!-- iOS Installation Instructions Modal -->
    <div id="ios-install-modal" class="ios-install-modal" onclick="closeIOSInstallModal(event)">
      <div class="ios-install-content" onclick="event.stopPropagation()">
        <div class="ios-install-header">ğŸ“± Install on iOS</div>
        
        <div style="margin-bottom: 20px; color: #666; font-size: 14px;">
          Follow these steps to add Pookie's app to your home screen:
        </div>

        <div class="ios-step">
          <div class="ios-step-number">1</div>
          <div class="ios-step-text">
            Tap the <strong>Share</strong> button <span class="ios-emoji">â¬†ï¸</span> at the bottom of Safari
          </div>
        </div>

        <div class="ios-step">
          <div class="ios-step-number">2</div>
          <div class="ios-step-text">
            Scroll down and tap <strong>"Add to Home Screen"</strong> <span class="ios-emoji">ğŸ“±</span>
          </div>
        </div>

        <div class="ios-step">
          <div class="ios-step-number">3</div>
          <div class="ios-step-text">
            Tap <strong>"Add"</strong> to confirm and create the app icon
          </div>
        </div>

        <div style="margin-top: 25px;">
          <button class="settings-btn settings-btn-primary" onclick="closeIOSInstallModal()">
            âœ… Got it!
          </button>
        </div>

        <div style="margin-top: 15px; font-size: 12px; color: #888;">
          The app will appear on your home screen and work like a native app!
        </div>
      </div>
    </div>

    <!-- Photo Preview Popup -->
    <div id="photo-preview-popup" class="photo-preview-popup" onclick="closePhotoPreview(event)">
      <div class="popup-content" onclick="event.stopPropagation()">
        <div class="popup-header">ğŸ’ Latest Shared Photo</div>
        <div id="photo-preview-content">
          <!-- Content will be loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Custom Boing Modal -->
    <div id="boing-modal">
      <div id="boing-modal-content">
        <h3>Your Boings Yesterday</h3>
        <p id="boing-message"></p>
        <button id="boing-ok">OK</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal" onclick="closeImageModal()">
      <div class="modal-content">
        <img id="modal-image" src="" alt="" />
      </div>
    </div>

    <!-- Audio -->
    <audio id="boing" src="assets/sounds/boing.mp3" preload="auto"></audio>

    <!-- Pre-load check script -->
    <script>
      // Quick check for development vs production
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        document.getElementById('debug-menu-btn').style.display = 'block';
        console.log('ğŸ› Development mode - debug tools available');
      }
      
      // Early localStorage check
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('âœ… localStorage available');
      } catch (error) {
        console.warn('âš ï¸ localStorage not available:', error);
        window.localStorageUnavailable = true;
      }
    </script>

    <!-- JavaScript -->
    <script type="module" src="js/main.js"></script>
  </body>
</html>