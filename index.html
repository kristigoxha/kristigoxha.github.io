<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pookie's Home</title>
    <link rel="icon" href="/assets/icons/favicon.ico" />
    
    <!-- Security -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co https://cdn.jsdelivr.net;
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co wss://bcjmlhxuakqqqdjrtntj.supabase.co https://marxfnwnc2.execute-api.eu-central-1.amazonaws.com https://www.merriam-webster.com;
      "
    />
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A loving app for Pookie with boings and photo sharing" />
    <meta name="theme-color" content="#a18cd1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pookie's Home" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-128x128.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192x192.png" />

    <!-- CSS Files with fallback styles -->
    <link rel="stylesheet" href="css/base.css" onerror="console.warn('Failed to load base.css')" />
    <link rel="stylesheet" href="css/layout.css" onerror="console.warn('Failed to load layout.css')" />
    <link rel="stylesheet" href="css/components.css" onerror="console.warn('Failed to load components.css')" />
    <link rel="stylesheet" href="css/animations.css" onerror="console.warn('Failed to load animations.css')" />
    
    <!-- Inline critical styles for cookie popup -->
    <style>
      .cookie-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .cookie-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }
      
      .cookie-popup {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        margin: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: cookieSlideIn 0.4s ease-out;
      }
      
      .cookie-popup h3 {
        margin-bottom: 15px;
        color: #333;
      }
      
      .cookie-popup p {
        margin-bottom: 20px;
        color: #666;
        line-height: 1.5;
      }
      
      .cookie-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      
      .cookie-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .cookie-btn-accept {
        background: #28a745;
        color: white;
      }
      
      .cookie-btn-reject {
        background: #dc3545;
        color: white;
      }
      
      .cookie-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      
      @keyframes cookieSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <!-- Service Worker Status (for debugging only) -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('js/sw.js');
      }
    </script>

    <!-- Cookie Notice -->
    <div id="cookie-overlay" class="cookie-overlay">
      <div class="cookie-popup">
        <h3>Cookie Notice</h3>
        <p>
          This website uses cookies for basic functionality like login and photo storage.
          It's just for functionality - no tracking or weird stuff!
        </p>
        <div class="cookie-buttons">
          <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">
            😊 That's fine!
          </button>
          <button class="cookie-btn cookie-btn-reject" onclick="rejectCookies()">
            😔 No doodoo thanks.
          </button>
        </div>
      </div>
    </div>

    <!-- LOGIN SECTION -->
	<div id="login-section">
		<div class="login-container">
			<div class="login-header">
				<span class="emoji">🎎</span>
				<h1>Welcome back pookie!</h1>
				<p>Sign in to your home</p>
			</div>

			<div class="login-form-group">
				<input type="email" id="email" placeholder="Enter your email" />
			</div>

			<div class="login-form-group">
				<input type="password" id="password" placeholder="Enter your password" />
			</div>

			<div class="login-btn-group">
				<button class="login-btn btn-secondary" onclick="register()">
					Create Account
				</button>
				<button class="login-btn btn-primary" onclick="login()">
					Sign In
				</button>
			</div>

			<div id="login-message" class="message"></div>

			<div class="reset-section">
				<h3>Forgot your password?</h3>
				<div class="login-form-group">
					<input type="email" id="reset-email" placeholder="Enter your email" />
				</div>
				<button class="reset-btn" onclick="resetPassword()">
					Send Reset Link
				</button>
				<div id="reset-message" class="message"></div>
			</div>
		</div>
	</div>

    <!-- APP SECTION -->
    <div id="app-section">
      <div id="counter">Boings today: <span id="todayCount">0</span></div>
      
      <button id="menu-toggle" class="hamburger" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      
      <nav id="menu">
        <button onclick="showSettingsModal()">⚙️ Settings</button>
        <button onclick="showPasswordModal()">🔒 Change Password</button>
        <button onclick="window.open('/pages/gallery.html', '_blank')">🖼️ Full Gallery</button>
        <button id="pwa-install-menu" class="pwa-install-menu-btn" onclick="handlePWAInstall()">
          📱 Install App
        </button>
        <button onclick="logout()">👋 Logout</button>
        <!-- Debug menu item (only show in development) -->
        <button onclick="document.getElementById('debug-info').style.display='block'" style="display: none;" id="debug-menu-btn">
          🐛 Debug Info
        </button>
      </nav>

      <div id="emoji">🎎</div>
      <div id="message">I LOVE YOU POOKIE</div>

      <a id="gift-box" href="/pages/gallery.html" target="_blank">
        🎁 Upload a surprise for Pookie
      </a>

      <button class="gallery-toggle" onclick="showPhotoPreview()">
        📸 Show Recent Shared Photos
      </button>

      <button class="playground-toggle" onclick="window.open('/pages/playground.html', '_blank')">
        🎮 Pookie's Playground
      </button>

      <div class="history-link">
        <a href="/pages/history.html" target="_blank">📊 View Boing History</a>
      </div>

      <div id="hint">
        Hint: Increase the audio and tap the emoji for a surprise booboo
      </div>
    </div>

    <!-- PWA Update Banner -->
    <div id="pwa-update-banner" class="pwa-update-banner">
      <span>🆕 App update available!</span>
      <button onclick="updatePWA()">Update</button>
      <button class="close-btn" onclick="hidePWAUpdateBanner()">Later</button>
    </div>

    <!-- Password Modal -->
    <div id="password-modal">
      <div>
        <h3>Change Password</h3>
        <input type="password" id="current-password" placeholder="Current Password" />
        <input type="password" id="new-password" placeholder="New Password" />
        <div>
          <button onclick="changePassword()">Update Password</button>
          <button onclick="closePasswordModal()">Cancel</button>
        </div>
        <div id="password-change-message"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal">
      <div>
        <h3>⚙️ Settings</h3>
        <div class="settings-section">
          <label for="autoreceiver-setting">Auto-receiver (photos sent to this person automatically):</label>
          <input 
            type="text" 
            id="autoreceiver-setting" 
            class="settings-input" 
            placeholder="Enter username or email"
            autocomplete="off"
          />
          <div class="autocomplete-suggestions" id="autoreceiver-suggestions"></div>
        </div>
        <div>
          <button onclick="saveSettings()">💾 Save Settings</button>
          <button onclick="closeSettingsModal()">❌ Cancel</button>
        </div>
        <div id="settings-message"></div>
      </div>
    </div>

    <!-- Photo Preview Popup -->
    <div id="photo-preview-popup" class="photo-preview-popup" onclick="closePhotoPreview(event)">
      <div class="popup-content">
        <button class="popup-close" onclick="closePhotoPreview()">×</button>
        <div class="popup-header">📸 Recent Shared Photos</div>
        <div id="photo-preview-content">
          <div class="loading">Loading photos...</div>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn popup-btn-primary" onclick="window.open('/pages/gallery.html', '_blank')">
            🖼️ Open Full Gallery
          </button>
          <button class="popup-btn popup-btn-secondary" onclick="closePhotoPreview()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Large Image Modal -->
    <div id="image-modal" class="modal" onclick="closeImageModal()">
      <div class="modal-content">
        <img id="modal-image" src="" alt="">
      </div>
    </div>

    <!-- Debug Info (hidden by default) -->
    <div id="debug-info" style="display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 1000;">
      <button onclick="this.parentElement.style.display='none'" style="float: right;">×</button>
      <div>User: <span id="debug-user">-</span></div>
      <div>Session: <span id="debug-session">-</span></div>
      <button onclick="debugAuth()">Debug Auth</button>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="js/main.js"></script>

    <!-- Password Reset Fix Script -->
    <script>
      // Check for password reset in URL
      document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        const isReset = hashParams.get('type') === 'recovery';
        const accessToken = hashParams.get('access_token');
        
        if (isReset && accessToken) {
          // Hide existing sections
          const loginSection = document.getElementById('login-section');
          const appSection = document.getElementById('app-section');
          
          if (loginSection) loginSection.style.display = 'none';
          if (appSection) appSection.style.display = 'none';
          
          // Create reset form
          const resetContainer = document.createElement('div');
          resetContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: 'Inter', sans-serif;
          `;
          
          resetContainer.innerHTML = `
            <div style="
              background: white;
              padding: 40px;
              border-radius: 20px;
              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
              width: 100%;
              max-width: 400px;
              text-align: center;
            ">
              <div style="font-size: 4rem; margin-bottom: 16px;">🔑</div>
              <h1 style="font-size: 2rem; margin-bottom: 8px; color: #4a5568;">Reset Your Password</h1>
              <p style="color: #718096; margin-bottom: 30px;">Enter your new password below</p>
              
              <form id="reset-form">
                <input 
                  type="password" 
                  id="new-password" 
                  placeholder="Enter new password" 
                  style="width: 100%; padding: 16px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; outline: none; transition: all 0.3s ease;"
                  required
                />
                <button 
                  type="submit"
                  style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;"
                >
                  Update Password
                </button>
                <div id="reset-status" style="margin-top: 15px; font-size: 14px;"></div>
              </form>
            </div>
          `;
          
          document.body.appendChild(resetContainer);
          
          // Handle form submission
          document.getElementById('reset-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const status = document.getElementById('reset-status');
            
            if (newPassword.length < 6) {
              status.innerHTML = '<div style="color: #e53e3e;">Password must be at least 6 characters</div>';
              return;
            }
            
            status.innerHTML = '<div style="color: #4299e1;">Updating password...</div>';
            
            try {
              // Update password using Supabase
              const { createClient } = window.supabase;
              const supabase = createClient(
                'https://bcjmlhxuakqqqdjrtntj.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjam1saHh1YWtxcXFkanJ0bnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ3Nzk3NDQsImV4cCI6MjA1MDM1NTc0NH0.rM7lvbcBSqpAV_RWNjyXC38kdWnJlsOBE9THCJGr7LU'
              );
              
              // Set the session using the access token
              const { data, error } = await supabase.auth.updateUser({
                password: newPassword
              });
              
              if (error) throw error;
              
              status.innerHTML = '<div style="color: #38a169;">✅ Password updated successfully!</div>';
              
              setTimeout(() => {
                resetContainer.remove();
                window.location.href = '/';
              }, 2000);
              
            } catch (error) {
              console.error('Reset error:', error);
              status.innerHTML = `<div style="color: #e53e3e;">Error: ${error.message}</div>`;
            }
          });
        }
      });
    </script>
  </body>
</html>