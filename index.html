<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pookie's Home</title>
    <link rel="icon" href="/assets/icons/favicon.ico" />
    
    <!-- Security -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co https://cdn.jsdelivr.net;
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        font-src 'self' data:;
        connect-src 'self' https://bcjmlhxuakqqqdjrtntj.supabase.co wss://bcjmlhxuakqqqdjrtntj.supabase.co https://marxfnwnc2.execute-api.eu-central-1.amazonaws.com https://www.merriam-webster.com;
      "
    />
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="A loving app for Pookie with boings and photo sharing" />
    <meta name="theme-color" content="#a18cd1" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Pookie's Home" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/icons/icon-128x128.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192x192.png" />

    <!-- CSS Files with fallback styles -->
    <link rel="stylesheet" href="css/base.css" onerror="console.warn('Failed to load base.css')" />
    <link rel="stylesheet" href="css/layout.css" onerror="console.warn('Failed to load layout.css')" />
    <link rel="stylesheet" href="css/components.css" onerror="console.warn('Failed to load components.css')" />
    <link rel="stylesheet" href="css/animations.css" onerror="console.warn('Failed to load animations.css')" />
    
    <!-- Inline critical styles for cookie popup -->
    <style>
      .cookie-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .cookie-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
      }
      
      .cookie-popup {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        margin: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: cookieSlideIn 0.4s ease-out;
      }
      
      @keyframes cookieSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .cookie-popup h2 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 1.5rem;
      }
      
      .cookie-popup p {
        margin: 0 0 20px 0;
        color: #666;
        line-height: 1.5;
      }
      
      .cookie-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .cookie-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }
      
      .cookie-btn-accept {
        background: #28a745;
        color: white;
      }
      
      .cookie-btn-accept:hover {
        background: #218838;
        transform: translateY(-2px);
      }
      
      .cookie-btn-reject {
        background: #6c757d;
        color: white;
      }
      
      .cookie-btn-reject:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }
    </style>
  </head>

  <body>
    <!-- Include Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Cookie consent overlay -->
    <div id="cookie-overlay" class="cookie-overlay">
      <div class="cookie-popup">
        <h2>🍪 Cookie Consent</h2>
        <p>
          We use a tiny cookie to remember your login status and make the app work smoothly. 
          It's just for functionality - no tracking or weird stuff!
        </p>
        <div class="cookie-buttons">
          <button class="cookie-btn cookie-btn-accept" onclick="acceptCookies()">
            😊 That's fine!
          </button>
          <button class="cookie-btn cookie-btn-reject" onclick="rejectCookies()">
            😔 No doodoo thanks.
          </button>
        </div>
      </div>
    </div>

    <!-- LOGIN SECTION -->
    <div id="login-section">
      <div class="login-container">
        <div class="login-header">
          <span class="emoji">🎎</span>
          <h1>Welcome back pookie!</h1>
          <p>Sign in to your home</p>
        </div>

        <div class="login-form-group">
          <input type="email" id="email" placeholder="Enter your email" />
        </div>

        <!-- Password field with visibility toggle -->
        <div class="login-form-group password-input-wrapper">
          <input type="password" id="password" placeholder="Enter your password" />
          <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('password')" aria-label="Toggle password visibility">
            <img src="/assets/images/eye-open-password.svg" alt="Show password" class="eye-icon" id="password-eye">
          </button>
        </div>

        <div class="login-btn-group">
          <button class="login-btn btn-secondary" onclick="register()">
            Create Account
          </button>
          <button class="login-btn btn-primary" onclick="login()">
            Sign In
          </button>
        </div>

        <div id="login-message" class="message"></div>

        <div class="reset-section">
          <h3>Forgot your password?</h3>
          <div class="login-form-group">
            <input type="email" id="reset-email" placeholder="Enter your email" />
          </div>
          <button class="reset-btn" onclick="resetPassword()">
            Send Reset Link
          </button>
          <div id="reset-message" class="message"></div>
        </div>
      </div>
    </div>

    <!-- APP SECTION -->
    <div id="app-section">
      <div class="pwa-status" id="pwa-status"></div>
      <div id="counter">Boings today: <span id="todayCount">0</span></div>
      
      <button id="menu-toggle" class="hamburger" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
      
      <nav id="menu">
        <button onclick="showSettingsModal()">⚙️ Settings</button>
        <button onclick="showPasswordModal()">🔒 Change Password</button>
        <button onclick="window.open('/pages/gallery.html', '_blank')">🖼️ Full Gallery</button>
        <button id="pwa-install-menu" class="pwa-install-menu-btn" onclick="handlePWAInstall()">
          📱 Install App
        </button>
        <button onclick="logout()">👋 Logout</button>
        <button onclick="document.getElementById('debug-info').style.display='block'" style="display: none;" id="debug-menu-btn">
          🐛 Debug Info
        </button>
      </nav>

      <div id="emoji">🎎</div>
      <div id="message">I LOVE YOU POOKIE</div>

      <a id="gift-box" href="/pages/gallery.html" target="_blank">
        🎁 Upload a surprise for Pookie
      </a>

      <button class="gallery-toggle" onclick="showPhotoPreview()">
        📸 Show Recent Shared Photos
      </button>

      <button class="playground-toggle" onclick="window.open('/pages/playground.html')">
        🎮 Pookie's Playground
      </button>

      <div class="history-link">
        <a href="/pages/history.html" target="_blank">📊 View Boing History</a>
      </div>

      <div id="hint">
        Hint: Increase the audio and tap the emoji for a surprise booboo
      </div>
    </div>

    <!-- PWA Update Banner -->
    <div id="pwa-update-banner" class="pwa-update-banner">
      <span>🆕 App update available!</span>
      <button onclick="updatePWA()">Update</button>
      <button class="close-btn" onclick="hidePWAUpdateBanner()">Later</button>
    </div>

    <!-- Password Modal -->
    <div id="password-modal">
      <div>
        <h3>Change Password</h3>
        
        <!-- Current password with visibility toggle -->
        <div class="password-input-wrapper">
          <input type="password" id="current-password" placeholder="Current Password" />
          <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('current-password')" aria-label="Toggle current password visibility">
            <img src="/assets/images/eye-open-password.svg" alt="Show password" class="eye-icon" id="current-password-eye">
          </button>
        </div>
        
        <!-- New password with visibility toggle -->
        <div class="password-input-wrapper">
          <input type="password" id="new-password" placeholder="New Password (min 8 characters)" />
          <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('new-password')" aria-label="Toggle new password visibility">
            <img src="/assets/images/eye-open-password.svg" alt="Show password" class="eye-icon" id="new-password-eye">
          </button>
        </div>
        
        <div>
          <button onclick="changePassword()">Update Password</button>
          <button onclick="closePasswordModal()">Cancel</button>
        </div>
        <div id="password-change-message"></div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal" onclick="closeSettingsModal(event)">
      <div class="settings-modal-content">
        <h2 class="settings-header">⚙️ Settings</h2>
        
        <!-- Current Username Section -->
        <div class="settings-section">
          <h3>👤 Username</h3>
          <div class="current-username">
            Current: <span id="current-username-text">Loading...</span>
          </div>
          <input 
            type="text" 
            id="new-username" 
            placeholder="Enter new username (optional)"
            class="settings-input"
          />
          <p class="settings-note">Leave blank to keep current username</p>
        </div>
        
        <!-- Auto-receiver Section -->
        <div class="settings-section">
          <h3>📬 Auto-receiver</h3>
          <p class="settings-note">Photos will be automatically shared with this person</p>
          
          <!-- Current auto-receiver display -->
          <div id="current-autoreceiver" class="autoreceiver-display" style="display: none;">
            <strong>Current auto-receiver:</strong>
            <div id="autoreceiver-tag-container"></div>
          </div>
          
          <input 
            type="email" 
            id="autoreceiver-email" 
            placeholder="Enter email address (optional)"
            class="settings-input"
          />
          <p class="settings-note">Leave blank to keep current auto-receiver</p>
        </div>
        
        <!-- Buttons -->
        <div class="settings-buttons">
          <button class="settings-btn settings-btn-primary" onclick="saveSettings()">
            💾 Save Changes
          </button>
          <button class="settings-btn settings-btn-secondary" onclick="closeSettingsModal()">
            ❌ Cancel
          </button>
        </div>
        
        <!-- Message display -->
        <div id="settings-message" class="message" style="margin-top: 15px; text-align: center;"></div>
      </div>
    </div>

    <!-- Photo Preview Popup -->
    <div id="photo-preview-popup" class="photo-preview-popup" onclick="closePhotoPreview(event)">
      <div class="popup-content">
        <button class="popup-close" onclick="closePhotoPreview()">×</button>
        <div class="popup-header">📸 Recent Shared Photos</div>
        <div id="photo-preview-content">
          <div class="loading">Loading photos...</div>
        </div>
        <div class="popup-buttons">
          <button class="popup-btn popup-btn-primary" onclick="window.open('/pages/gallery.html', '_blank')">
            🖼️ Open Full Gallery
          </button>
          <button class="popup-btn popup-btn-secondary" onclick="closePhotoPreview()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Large Image Modal -->
    <div id="image-modal" class="modal" onclick="closeImageModal()">
      <div class="modal-content">
        <img id="modal-image" src="" alt="">
      </div>
    </div>

    <!-- Debug Info -->
    <div id="debug-info" style="display: none; position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 1000;">
      <button onclick="this.parentElement.style.display='none'" style="float: right;">×</button>
      <div>User: <span id="debug-user">-</span></div>
      <div>Session: <span id="debug-session">-</span></div>
      <button onclick="debugAuth()">Debug Auth</button>
    </div>

    <!-- JavaScript Modules -->
    <script type="module" src="js/main.js"></script>

    <!-- Password Toggle JavaScript -->
    <script>
      // Toggle password visibility using SVG icons
      function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        const eyeIcon = document.getElementById(inputId + '-eye');
        
        if (passwordInput.type === 'password') {
          // Show password - use closed eye icon
          passwordInput.type = 'text';
          eyeIcon.src = '/assets/images/eye-closed-password.svg';
          eyeIcon.alt = 'Hide password';
        } else {
          // Hide password - use open eye icon
          passwordInput.type = 'password';
          eyeIcon.src = '/assets/images/eye-open-password.svg';
          eyeIcon.alt = 'Show password';
        }
      }
    </script>

    <!-- Password Reset Fix Script -->
    <script>
      // Check for password reset in URL
      document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        const isReset = hashParams.get('type') === 'recovery';
        const accessToken = hashParams.get('access_token');
        
        if (isReset && accessToken) {
          // Hide existing sections
          const loginSection = document.getElementById('login-section');
          const appSection = document.getElementById('app-section');
          
          if (loginSection) loginSection.style.display = 'none';
          if (appSection) appSection.style.display = 'none';
          
          // Create reset form
          const resetContainer = document.createElement('div');
          resetContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            font-family: 'Inter', sans-serif;
          `;
          
          resetContainer.innerHTML = `
            <div style="
              background: white;
              padding: 40px;
              border-radius: 20px;
              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
              width: 100%;
              max-width: 400px;
              text-align: center;
            ">
              <div style="font-size: 4rem; margin-bottom: 16px;">🔑</div>
              <h1 style="font-size: 2rem; margin-bottom: 8px; color: #4a5568;">Reset Your Password</h1>
              <p style="color: #718096; margin-bottom: 30px;">Enter your new password below</p>
              
              <form id="reset-form">
                <input 
                  type="password" 
                  id="new-password" 
                  placeholder="Enter new password" 
                  style="width: 100%; padding: 16px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box;"
                  required
                />
                <input 
                  type="password" 
                  id="confirm-password" 
                  placeholder="Confirm new password" 
                  style="width: 100%; padding: 16px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box;"
                  required
                />
                <button 
                  type="submit" 
                  id="reset-btn"
                  style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;"
                >
                  Update Password
                </button>
              </form>
              
              <div id="reset-message" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
              
              <a href="/" style="display: inline-block; margin-top: 20px; color: #667eea; text-decoration: none; font-weight: 500;">← Back to Login</a>
            </div>
          `;
          
          document.body.appendChild(resetContainer);
          
          // Handle form submission
          document.getElementById('reset-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resetBtn = document.getElementById('reset-btn');
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageEl = document.getElementById('reset-message');
            
            function showMessage(message, isError) {
              messageEl.textContent = message;
              messageEl.style.display = 'block';
              messageEl.style.background = isError ? '#ffebee' : '#e8f5e8';
              messageEl.style.color = isError ? '#c62828' : '#2e7d32';
            }
            
            if (newPassword !== confirmPassword) {
              showMessage('Passwords do not match', true);
              return;
            }
            
            if (newPassword.length < 6) {
              showMessage('Password must be at least 6 characters', true);
              return;
            }
            
            resetBtn.disabled = true;
            resetBtn.textContent = 'Updating...';
            
            try {
              const { supabase } = await import('./js/config.js');
              
              const { access_token, refresh_token } = Object.fromEntries(hashParams);
              
              await supabase.auth.setSession({ access_token, refresh_token });
              
              const { error } = await supabase.auth.updateUser({ password: newPassword });
              
              if (error) throw error;
              
              showMessage('Password updated successfully! Redirecting...', false);
              setTimeout(() => window.location.href = '/', 2000);
              
            } catch (error) {
              showMessage(error.message, true);
              resetBtn.disabled = false;
              resetBtn.textContent = 'Update Password';
            }
          });
        }
      });
    </script>

    <!-- Hamburger Menu Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const menuToggle = document.getElementById('menu-toggle');
        const menu = document.getElementById('menu');
        
        if (menuToggle && menu) {
          // Toggle menu on hamburger click
          menuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('open');
            menuToggle.classList.toggle('active');
            console.log('Menu toggled:', menu.classList.contains('open') ? 'opened' : 'closed');
          });
          
          // Close menu when clicking outside
          document.addEventListener('click', function(e) {
            if (!menu.contains(e.target) && !menuToggle.contains(e.target)) {
              menu.classList.remove('open');
              menuToggle.classList.remove('active');
              console.log('Menu closed by clicking outside');
            }
          });
          
          // Close menu when clicking a menu item
          const menuItems = menu.querySelectorAll('a, button');
          menuItems.forEach(item => {
            item.addEventListener('click', function() {
              menu.classList.remove('open');
              menuToggle.classList.remove('active');
              console.log('Menu closed by selecting item');
            });
          });
          
          console.log('Hamburger menu setup complete!');
        } else {
          console.error('Menu elements not found:', {
            menuToggle: !!menuToggle,
            menu: !!menu
          });
        }
      });
    </script>
  </body>
</html>